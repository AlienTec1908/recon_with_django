{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Live Sensor Recon</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="{% static 'scanner/style.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'scanner/OPS_Panel.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'scanner/live_banner.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'scanner/Tabs.css' %}">
</head>
<body>

    <div id="command-leiste">
        <div class="leiste-logo">OPS</div>
        <div class="leiste-form-container">
            <input type="text" id="target-input" placeholder="Enter Target..." required>
            <button type="button" id="start-scan-button" class="leiste-start-button">Start Scan</button>
        </div>
        <div class="leiste-stopp-container">
            <button id="stop-all-button" class="leiste-stopp-button" title="Stop All Scans">
                <i class="fa-solid fa-power-off"></i>
                <span>Stop All</span>
            </button>
        </div>
        
        <div class="threat-circle-container">
            <div id="threat-circle" class="circle"></div>
        </div>

        <div class="active-ops-header">
            <span>Active Ops</span>
        </div>
        <div id="active-ops-list"></div>
    </div>

    <div id="page-wrapper">
        <div id="threat-hud">
            <div class="hud-section-left">
                <div class="hud-label">CURRENT OPERATION:</div>
                <div id="current-operation-text" class="hud-operation-text">> STANDBY</div>
                <div id="waveform" class="waveform-standby">
                    <div class="wave-bar"></div>
                    <div class="wave-bar"></div>
                    <div class="wave-bar"></div>
                    <div class="wave-bar"></div>
                    <div class="wave-bar"></div>
                    <div class="wave-bar"></div>
                    <div class="wave-bar"></div>
                </div>
            </div>
            <div class="hud-section-right">
                <div id="threat-matrix" class="threat-matrix">
                    <div class="matrix-cell hard">
                        <span class="sev-label">HARD</span>
                        <span id="sev-hard-count" class="sev-count">0</span>
                    </div>
                    <div class="matrix-cell medium">
                        <span class="sev-label">MEDIUM</span>
                        <span id="sev-medium-count" class="sev-count">0</span>
                    </div>
                    <div class="matrix-cell easy">
                        <span class="sev-label">EASY</span>
                        <span id="sev-easy-count" class="sev-count">0</span>
                    </div>
                    <div class="matrix-cell info">
                        <span class="sev-label">INFO</span>
                        <span id="sev-info-count" class="sev-count">0</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="main-content">
            <div class="progress-bar-container">
                <div id="progress-bar-fill" class="progress-bar-fill"></div>
                <div class="progress-overlay-content">
                    <div class="progress-circle-container">
                        <svg class="progress-ring" width="60" height="60">
                           <circle class="progress-ring__track" stroke-width="4" fill="transparent" r="26" cx="30" cy="30"/>
                           <circle id="progress-ring-circle" class="progress-ring__circle" stroke-width="4" fill="transparent" r="26" cx="30" cy="30"/>
                        </svg>
                        <span id="progress-steps" class="progress-circle-text">0/{{ total_scans }}</span>
                    </div>
                    <span id="progress-percentage" class="progress-percentage-text">0%</span>
                </div>
            </div>

            <div id="tactical-deck">
                <div class="deck-pills-container">
                    <span class="deck-placeholder">Waiting for actionable intelligence...</span>
                </div>
                <button class="run-button" disabled>RUN &gt;&gt;</button>
            </div>

            <div id="system-messages">
                <div class="glass-crack-1"></div>
                <div class="glass-crack-2"></div>
                <div id="system-messages-content">
                    <table>
                        <tbody id="system-messages-tbody"></tbody>
                    </table>
                </div>
            </div>
            
            <div id="intelligence-deck">
                <div id="tabbed-console">
                    <div class="tab-bar-wrapper">
                        <div id="tab-bar" class="tab-bar">
                            <button class="tab-button active" data-scan-id="nmap_full">Nmap Full</button>
                            <button class="tab-button" data-scan-id="nmap_udp">Nmap UDP</button>
                            <button class="tab-button" data-scan-id="curl_cookies">Cookies</button>
                            <button class="tab-button" data-scan-id="nikto">Nikto</button>
                            <button class="tab-button" data-scan-id="ferox_common">Feroxbuster</button>
                            <button class="tab-button" data-scan-id="curl_headers">Headers</button>
                        </div>
                    </div>
                    <div id="tab-content" class="tab-content">
                        <div id="scan-card-nmap_full" class="scan-card active">
                            <div class="scan-header"><h3>Nmap Full Scan</h3><div class="scan-status"><span class="status-pending">Pending</span></div></div><pre></pre>
                        </div>
                        <div id="scan-card-nmap_udp" class="scan-card">
                            <div class="scan-header"><h3>Nmap UDP Scan</h3><div class="scan-status"><span class="status-pending">Pending</span></div></div><pre></pre>
                        </div>
                        <div id="scan-card-curl_cookies" class="scan-card">
                            <div class="scan-header"><h3>Curl - Cookie Jar</h3><div class="scan-status"><span class="status-pending">Pending</span></div></div><pre></pre>
                        </div>
                        <div id="scan-card-nikto" class="scan-card">
                            <div class="scan-header"><h3>Nikto Scan</h3><div class="scan-status"><span class="status-pending">Pending</span></div></div><pre></pre>
                        </div>
                        <div id="scan-card-ferox_common" class="scan-card">
                            <div class="scan-header"><h3>Feroxbuster - Common Dirs</h3><div class="scan-status"><span class="status-pending">Pending</span></div></div><pre></pre>
                        </div>
                        <div id="scan-card-curl_headers" class="scan-card">
                            <div class="scan-header"><h3>Curl - HTTP Headers</h3><div class="scan-status"><span class="status-pending">Pending</span></div></div><pre></pre>
                        </div>
                    </div>
                </div>
                {% include 'scanner/banner.html' %}
            </div>

        </div>
        <footer class="footer">
            <div class="footer-content-wrapper">
                <div class="footer-content">
                    <div class="footer-left">
                        <h3>Live Sensor Recon</h3>
                        <p>A dynamic and modular reconnaissance framework.</p>
                    </div>
                    <div class="footer-right">
                        <p>Connect with the creator:</p>
                        <div class="social-icons">
                            <a href="https://github.com/AlienTec1908" target="_blank" rel="noopener noreferrer" class="social-link github"><i class="fa-brands fa-github"></i> GitHub</a>
                            <a href="https://hackmyvm.eu/public/?u=darkspirit" target="_blank" rel="noopener noreferrer" class="social-link hackmyvm"><i class="fa-solid fa-trophy"></i> HackMyVM</a>
                        </div>
                    </div>
                </div>
                <div class="footer-bottom">
                    <p>&copy; 2026 Live Sensor Recon. All Rights Reserved.</p>
                </div>
            </div>
        </footer>
    </div>
    <script>
        const startScanButton = document.getElementById('start-scan-button');
        const targetInput = document.getElementById('target-input');
        const systemMessagesTbody = document.getElementById('system-messages-tbody');
        const tabBar = document.getElementById('tab-bar');
        const tabContent = document.getElementById('tab-content');
        const stopAllButton = document.getElementById('stop-all-button');
        const activeOpsList = document.getElementById('active-ops-list');
        const progressBarFill = document.getElementById('progress-bar-fill');
        const progressPercentageText = document.getElementById('progress-percentage');
        const progressStepsText = document.getElementById('progress-steps');
        const progressRing = document.getElementById('progress-ring-circle');
        
        const threatHud = document.getElementById('threat-hud');
        const currentOperationText = document.getElementById('current-operation-text');
        const waveform = document.getElementById('waveform');
        const sevHardCount = document.getElementById('sev-hard-count');
        const sevMediumCount = document.getElementById('sev-medium-count');
        const sevEasyCount = document.getElementById('sev-easy-count');
        const sevInfoCount = document.getElementById('sev-info-count');
        const threatCircle = document.getElementById('threat-circle');

        const radius = progressRing.r.baseVal.value;
        const circumference = radius * 2 * Math.PI;
        progressRing.style.strokeDasharray = `${circumference} ${circumference}`;
        const totalScans = {{ total_scans }};
        let completedScans = 0;
        let severityCounts = { Hard: 0, Medium: 0, Easy: 0, Info: 0 };

        const TOP_SCANS = ['nmap_full', 'nmap_udp', 'curl_cookies', 'nikto', 'ferox_common', 'curl_headers'];
        const SCAN_ICONS = {
            'nmap_full': 'fa-magnifying-glass', 'ferox_common': 'fa-route', 'nikto': 'fa-shield-virus',
            'nmap_udp': 'fa-satellite-dish', 'curl_headers': 'fa-file-lines', 'curl_cookies': 'fa-cookie-bite', 'default': 'fa-crosshairs'
        };
        const websocketUrl = '{{ websocket_url }}';

        function updateThreatCircle() {
            const weights = { Hard: 10, Medium: 5, Easy: 2, Info: 1 };
            const weightedScores = {
                Hard: severityCounts.Hard * weights.Hard,
                Medium: severityCounts.Medium * weights.Medium,
                Easy: severityCounts.Easy * weights.Easy,
                Info: severityCounts.Info * weights.Info
            };
            const totalWeight = Object.values(weightedScores).reduce((a, b) => a + b, 0);
            if (totalWeight === 0) {
                threatCircle.style.background = '#333';
                return;
            }
            
            const hardPercent = (weightedScores.Hard / totalWeight) * 100;
            const mediumPercent = (weightedScores.Medium / totalWeight) * 100;
            const easyPercent = (weightedScores.Easy / totalWeight) * 100;

            const hardEnd = hardPercent;
            const mediumEnd = hardEnd + mediumPercent;
            const easyEnd = mediumEnd + easyPercent;
            
            const gradient = `conic-gradient(
                #e53935 0% ${hardEnd}%,
                #ffa726 ${hardEnd}% ${mediumEnd}%,
                #28a745 ${mediumEnd}% ${easyEnd}%,
                #00aaff ${easyEnd}% 100%
            )`;
            
            threatCircle.style.background = gradient;
        }

        function getPillColor(label) {
            let hash = 0;
            for (let i = 0; i < label.length; i++) {
                hash = label.charCodeAt(i) + ((hash << 5) - hash);
            }
            const colorPairs = [
                ["#007bff", "#ffffff"], ["#ffc107", "#000000"], ["#dc3545", "#ffffff"],
                ["#17a2b8", "#ffffff"], ["#6f42c1", "#ffffff"], ["#28a745", "#ffffff"],
                ["#6c757d", "#ffffff"], ["#fd7e14", "#000000"], ["#e83e8c", "#ffffff"]
            ];
            const index = Math.abs(hash % colorPairs.length);
            return colorPairs[index];
        }
        
        function resetUI() {
            systemMessagesTbody.innerHTML = '';
            activeOpsList.innerHTML = '';
            completedScans = 0;
            severityCounts = { Hard: 0, Medium: 0, Easy: 0, Info: 0 };
            sevHardCount.textContent = severityCounts.Hard;
            sevMediumCount.textContent = severityCounts.Medium;
            sevEasyCount.textContent = severityCounts.Easy;
            sevInfoCount.textContent = severityCounts.Info;
            currentOperationText.textContent = '> STANDBY';
            waveform.className = 'waveform-standby';
            updateThreatCircle();
            updateProgressBar();

            document.querySelectorAll('.pills-container').forEach(container => {
                container.innerHTML = '<span class="placeholder-pill">[x]</span>';
            });
            document.getElementById('info-hostname').textContent = '...';
            document.getElementById('info-ip').textContent = '...';
            document.getElementById('info-location').textContent = '...';
            document.getElementById('info-time').textContent = '...';
            
            document.querySelectorAll('.scan-card').forEach(card => {
                card.querySelector('pre').textContent = '';
                card.querySelector('.scan-status').innerHTML = '<span class="status-pending">Pending</span>';
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('has-new-output', 'is-completed');
            });
            switchTab('nmap_full');
        }

        function updateProgressBar() {
            const percentage = totalScans > 0 ? (completedScans / totalScans) * 100 : 0;
            const offset = circumference - (percentage / 100) * circumference;
            progressBarFill.style.width = `${percentage}%`;
            progressRing.style.strokeDashoffset = offset;
            progressStepsText.textContent = `${completedScans}/${totalScans}`;
            progressPercentageText.textContent = `${Math.round(percentage)}%`;
        }
        
        function switchTab(scanId) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.scan-card').forEach(card => card.classList.remove('active'));
            const tabButton = document.querySelector(`.tab-button[data-scan-id="${scanId}"]`);
            const scanCard = document.getElementById(`scan-card-${scanId}`);
            if (tabButton) {
                tabButton.classList.add('active');
                tabButton.classList.remove('has-new-output', 'is-completed');
            }
            if (scanCard) {
                scanCard.classList.add('active');
                const pre = scanCard.querySelector('pre');
                if (pre) pre.scrollTop = pre.scrollHeight;
            }
        }

        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => switchTab(button.dataset.scanId));
        });

        async function stopScanInCard(event) {
            const button = event.target.closest('.stop-button');
            const scanId = button.dataset.scanId;
            button.disabled = true;
            button.innerHTML = 'Stopping...';
            const apiUrl = websocketUrl.replace('ws://', 'http://').replace('/ws', '');
            try {
                const response = await fetch(`${apiUrl}/api/scans/${scanId}/stop`, { method: 'POST' });
                const statusDiv = button.parentElement;
                if (response.ok && statusDiv) {
                    statusDiv.innerHTML = '<span class="status-canceled">CANCELED</span>';
                } else if (statusDiv) {
                    statusDiv.innerHTML = '<span class="status-failed">Stop Failed</span>';
                }
            } catch (error) {
                if (button) {
                    button.disabled = false;
                    button.innerHTML = "Stop";
                }
            }
        }

        async function stopAllScans() {
            stopAllButton.disabled = true;
            const span = stopAllButton.querySelector('span');
            if (span) span.textContent = "Stopping...";
            const apiUrl = websocketUrl.replace('ws://', 'http://').replace('/ws', '');
            try {
                await fetch(`${apiUrl}/api/scans/stop_all`, { method: 'POST' });
                document.querySelectorAll('.scan-status').forEach(div => {
                    if (div.querySelector('.stop-button')) div.innerHTML = '<span class="status-canceled">CANCELED</span>';
                });
                document.querySelectorAll('.active-ops-item').forEach(item => item.remove());
                currentOperationText.textContent = '> STOPPED';
                waveform.className = 'waveform-standby';
            } catch(e) { console.error("Error stopping all scans:", e); }
            finally {
                stopAllButton.disabled = false;
                if(span) span.textContent = "Stop All";
            }
        }
        
        function addSystemMessage(data) {
            const row = systemMessagesTbody.insertRow();
            const statusCell = row.insertCell();
            const eventCell = row.insertCell();
            const detailsCell = row.insertCell();
            const timeCell = row.insertCell();
            
            const statusTag = document.createElement('span');
            statusTag.className = `status-tag status-${data.status.toLowerCase()}`;
            statusTag.textContent = data.status;
            statusCell.appendChild(statusTag);
            
            eventCell.textContent = data.event;
            detailsCell.textContent = data.details;
            timeCell.textContent = data.timestamp;
            
            const contentDiv = document.getElementById('system-messages-content');
            contentDiv.scrollTop = contentDiv.scrollHeight;
        }

        function startScan() {
            let ws = window.currentWs;
            if (ws) ws.close();
            resetUI();
            const target = targetInput.value;
            if (!target) {
                alert("Please enter a target.");
                return;
            }
            
            threatHud.classList.add('glitch');
            setTimeout(() => {
                threatHud.classList.remove('glitch');
            }, 300);
            waveform.className = 'waveform-scanning';

            ws = new WebSocket(websocketUrl);
            window.currentWs = ws;
            ws.onopen = function(e) {
                ws.send(JSON.stringify({ command: "start_scan", target: target }));
            };
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                
                if (data.type === 'system') {
                    addSystemMessage(data);
                } else if (data.type === 'target_info') {
                    document.getElementById('info-hostname').textContent = data.data.hostname;
                    document.getElementById('info-ip').textContent = data.data.target_ip;
                    document.getElementById('info-location').textContent = data.data.location;
                    document.getElementById('info-time').textContent = data.data.start_time;
                } else if (data.type === 'finding') {
                    if (data.severity in severityCounts) {
                        severityCounts[data.severity]++;
                        sevHardCount.textContent = severityCounts.Hard;
                        sevMediumCount.textContent = severityCounts.Medium;
                        sevEasyCount.textContent = severityCounts.Easy;
                        sevInfoCount.textContent = severityCounts.Info;
                        updateThreatCircle();
                    }
                    const containerId = `findings-${data.category}`;
                    const container = document.getElementById(containerId);
                    if (container) {
                        if (container.querySelector('.placeholder-pill')) container.innerHTML = '';
                        const pillId = `pill-${data.category}-${data.value}`.replace(/[^a-zA-Z0-9-_]/g, '');
                        if (!document.getElementById(pillId)) {
                            const pill = document.createElement('span');
                            pill.id = pillId;
                            pill.className = 'finding-pill';
                            const colors = getPillColor(data.value);
                            pill.style.backgroundColor = colors[0];
                            pill.style.color = colors[1];
                            pill.textContent = data.value;
                            container.appendChild(pill);
                        }
                    }
                } else if (data.type === 'status') {
                    const lineLower = data.line ? data.line.toLowerCase() : '';
                    const activeOpId = `active-op-${data.scan_id}`;
                    let activeOp = document.getElementById(activeOpId);
                    if (lineLower.includes('starting')) {
                        currentOperationText.textContent = `> ${data.scan_display_name}`;
                        if (!activeOp) {
                            activeOp = document.createElement('div');
                            activeOp.id = activeOpId;
                            activeOp.className = 'active-ops-item';
                            const iconClass = SCAN_ICONS[data.scan_name_slug] || SCAN_ICONS['default'];
                            activeOp.innerHTML = `<div class="heartbeat"></div><i class="fa-solid ${iconClass}"></i><span>${data.scan_display_name}</span><div class="op-progress"></div>`;
                            activeOpsList.appendChild(activeOp);
                        }
                    } else if (lineLower.includes('completed') || lineLower.includes('skipped') || lineLower.includes('failed')) {
                        if(activeOp) activeOp.remove();
                        completedScans++;
                        updateProgressBar();
                    }
                    
                    if (TOP_SCANS.includes(data.scan_name)) {
                        const scanCard = document.getElementById(`scan-card-${data.scan_name}`);
                        const statusDiv = scanCard.querySelector('.scan-status');
                        if (statusDiv) {
                            if (lineLower.includes('starting')) {
                                statusDiv.innerHTML = `<button class="stop-button" data-scan-id="${data.scan_id}">Stop</button>`;
                                statusDiv.querySelector('.stop-button').addEventListener('click', stopScanInCard);
                            } else if (lineLower.includes('completed')) {
                                statusDiv.innerHTML = '<span class="status-finished">Completed</span>';
                                const tabButton = document.querySelector(`.tab-button[data-scan-id="${data.scan_name}"]`);
                                if (tabButton) {
                                    tabButton.classList.remove('has-new-output');
                                    tabButton.classList.add('is-completed');
                                }
                            } else if (lineLower.includes('skipped')) { statusDiv.innerHTML = '<span class="status-skipped">Skipped</span>';
                            } else if (lineLower.includes('failed')) { statusDiv.innerHTML = '<span class="status-failed">Failed</span>'; }
                        }
                    }
                } else if (data.type === 'output') {
                    const activeOp = document.getElementById(`active-op-${data.scan_id}`);
                    if(activeOp) {
                        const progress = activeOp.querySelector('.op-progress');
                        const newWidth = Math.min(100, (parseFloat(progress.style.width) || 0) + 2);
                        progress.style.width = `${newWidth}%`;
                    }

                    if (TOP_SCANS.includes(data.scan_name)) {
                        const scanCard = document.getElementById(`scan-card-${data.scan_name}`);
                        if (scanCard) {
                            const pre = scanCard.querySelector('pre');
                            pre.textContent += data.line + '\n';
                            if (scanCard.classList.contains('active')) {
                                pre.scrollTop = pre.scrollHeight;
                            } else {
                                const tabButton = document.querySelector(`.tab-button[data-scan-id="${data.scan_name}"]`);
                                if(tabButton) tabButton.classList.add('has-new-output');
                            }
                        }
                    }
                }
            };
            ws.onclose = function(event) {};
            ws.onerror = function(error) {};
        }
        
        stopAllButton.addEventListener('click', stopAllScans);
        startScanButton.addEventListener('click', startScan);
        targetInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                startScan();
            }
        });
        
        resetUI();
    </script>
</body>
</html>
